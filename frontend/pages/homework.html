<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/subjects.html">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html" class="active">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –î–ó</button>
        </div>

        <div id="homework-list"></div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å *</label>
                    <select id="class-id" required></select>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–µ–¥–º–µ—Ç *</label>
                    <select id="subject-id" required></select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ *</label>
                    <input type="date" id="assigned-date" required>
                </div>
                <div class="form-group">
                    <label>–°—Ä–æ–∫ —Å–¥–∞—á–∏ *</label>
                    <input type="date" id="due-date" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è *</label>
                    <textarea id="description" rows="5" required placeholder="–ü–∞—Ä–∞–≥—Ä–∞—Ñ 15, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è 1-10"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('assigned-date').valueAsDate = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 7);
            document.getElementById('due-date').valueAsDate = tomorrow;
            await loadHomework();
        });

        async function loadHomework() {
            const response = await fetch(`${API_BASE}/homework`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                renderHomework(data.homework || []);
            }
        }

        function renderHomework(homework) {
            const container = document.getElementById('homework-list');
            if (homework.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;margin-top:40px;">–î–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            container.innerHTML = homework.map(h => {
                const dueDate = new Date(h.due_date);
                const isOverdue = dueDate < new Date();
                return `
                    <div style="background:white;border-radius:12px;padding:20px;margin:15px 0;border-left:5px solid ${isOverdue ? '#ff6b6b' : '#667eea'};">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <h3>${h.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç'} - ${h.class?.name || '–ö–ª–∞—Å—Å'}</h3>
                                <p style="color:#666;margin:10px 0;">${h.description}</p>
                                <p style="font-size:0.9rem;color:#999;">
                                    –ó–∞–¥–∞–Ω–æ: ${new Date(h.assigned_date).toLocaleDateString('ru-RU')} | 
                                    –°—Ä–æ–∫: ${dueDate.toLocaleDateString('ru-RU')} ${isOverdue ? '‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : ''}
                                </p>
                            </div>
                            <button onclick="deleteHomework(${h.id})" class="btn btn-sm" style="background:#ff6b6b;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openCreateModal() {
            const classesRes = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (classesRes.ok) {
                const data = await classesRes.json();
                const select = document.getElementById('class-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
                data.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }

            const subjectsRes = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (subjectsRes.ok) {
                const data = await subjectsRes.json();
                const select = document.getElementById('subject-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>';
                data.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });
            }

            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const homeworkData = {
                class_id: parseInt(document.getElementById('class-id').value),
                subject_id: parseInt(document.getElementById('subject-id').value),
                assigned_date: document.getElementById('assigned-date').value,
                due_date: document.getElementById('due-date').value,
                description: document.getElementById('description').value
            };

            const response = await fetch(`${API_BASE}/homework`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(homeworkData)
            });

            if (response.ok) {
                alert('‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
                closeCreateModal();
                loadHomework();
            } else {
                const error = await response.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å'));
            }
        });

        async function deleteHomework(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –î–ó?')) return;

            const response = await fetch(`${API_BASE}/homework/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('‚úÖ –î–ó —É–¥–∞–ª–µ–Ω–æ!');
                loadHomework();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
