<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .users-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .role-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .role-admin { background: #ff6b6b; color: white; }
        .role-teacher { background: #4ecdc4; color: white; }
        .role-student { background: #45b7d1; color: white; }
        .role-parent { background: #96ceb4; color: white; }
        .role-starosta { background: #ffeaa7; color: #333; }
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-bar select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html" class="active">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>

        <div class="filter-bar">
            <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏:</label>
            <select id="role-filter" onchange="loadUsers()">
                <option value="">–í—Å–µ</option>
                <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                <option value="teacher">–£—á–∏—Ç–µ–ª—è</option>
                <option value="student">–£—á–µ–Ω–∏–∫–∏</option>
                <option value="parent">–†–æ–¥–∏—Ç–µ–ª–∏</option>
                <option value="starosta">–°—Ç–∞—Ä–æ—Å—Ç—ã</option>
            </select>
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–§–ò–û</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>–†–æ–ª—å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <tr><td colspan="7" style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ò–º—è *</label>
                    <input type="text" id="first-name" required>
                </div>
                <div class="form-group">
                    <label>–§–∞–º–∏–ª–∏—è *</label>
                    <input type="text" id="last-name" required>
                </div>
                <div class="form-group">
                    <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
                    <input type="text" id="middle-name">
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="password" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>–†–æ–ª—å *</label>
                    <select id="role" required onchange="toggleTeacherField()">
                        <option value="student">–£—á–µ–Ω–∏–∫</option>
                        <option value="teacher">–£—á–∏—Ç–µ–ª—å</option>
                        <option value="parent">–†–æ–¥–∏—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-group" id="teacher-subject-group" style="display:none;">
                    <label>–ü—Ä–µ–¥–º–µ—Ç *</label>
                    <select id="teacher-subject">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        let currentUser = null;

        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadUsers();
        });

        async function loadCurrentUser() {
            const response = await fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                currentUser = data.user;
                document.getElementById('user-name').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
            } else {
                logout();
            }
        }

        async function loadUsers() {
            const role = document.getElementById('role-filter').value;
            const url = role ? `${API_BASE}/users?role=${role}` : `${API_BASE}/users`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('users-tbody');
                
                if (data.users && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(u => `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.last_name} ${u.first_name} ${u.middle_name || ''}</td>
                            <td>${u.username}</td>
                            <td>${u.email}</td>
                            <td><span class="role-badge role-${u.role}">${getRoleName(u.role)}</span></td>
                            <td>
                                ${u.role === 'teacher' && u.teacher_subject 
                                    ? `<span style="background:#667eea; color:white; padding:4px 8px; border-radius:5px; font-size:0.85rem;">üìö ${u.teacher_subject}</span>` 
                                    : '<span style="color:#999;">-</span>'
                                }
                            </td>
                            <td>
                                <button onclick="deleteUser(${u.id})" class="btn btn-sm" style="background:#ff6b6b">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                }
            }
        }

        function getRoleName(role) {
            const names = {
                admin: '–ê–¥–º–∏–Ω',
                teacher: '–£—á–∏—Ç–µ–ª—å',
                student: '–£—á–µ–Ω–∏–∫',
                parent: '–†–æ–¥–∏—Ç–µ–ª—å',
                starosta: '–°—Ç–∞—Ä–æ—Å—Ç–∞'
            };
            return names[role] || role;
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                middle_name: document.getElementById('middle-name').value
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å
            if (data.role === 'teacher') {
                const teacherSubject = document.getElementById('teacher-subject').value;
                if (teacherSubject) {
                    data.teacher_subject = teacherSubject;
                }
            }
            
            const response = await fetch(`${API_BASE}/users`, {  // –ò–∑–º–µ–Ω–µ–Ω–æ —Å /auth/register
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!');
                closeCreateModal();
                await loadUsers();
            } else {
                const error = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å'));
            }
        });

        async function deleteUser(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            
            const response = await fetch(`${API_BASE}/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω!');
                await loadUsers();
            } else {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        function toggleTeacherField() {
            const role = document.getElementById('role').value;
            const group = document.getElementById('teacher-subject-group');
            
            if (role === 'teacher') {
                group.style.display = 'block';
                loadSubjectsForTeacher();
            } else {
                group.style.display = 'none';
            }
        }

        async function loadSubjectsForTeacher() {
            const response = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('teacher-subject');
                
                if (data.subjects && data.subjects.length > 0) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>' + 
                        data.subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>';
                }
            }
        }
    </script>
</body>
</html>
