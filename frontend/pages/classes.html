<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∞—Å—Å—ã - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .class-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        .class-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .class-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a1a1a;
        }
        .class-year {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .class-info {
            margin: 10px 0;
            color: #666;
        }
        .class-info p {
            margin: 5px 0;
        }
        .class-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .class-actions button {
            flex: 1 1 auto;
            min-width: 100px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .students-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .student-item {
            padding: 8px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <h2>üéì ClassKeeper</h2>
        </div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/classes.html" class="active">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–ó</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏</h1>
            <button onclick="openCreateModal()" class="btn btn-primary" id="create-btn">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</button>
        </div>

        <div class="classes-grid" id="classes-grid">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞ -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ *</label>
                    <input type="text" id="class-name" placeholder="9–ê">
                </div>
                <div class="form-group">
                    <label>–£—á–µ–±–Ω—ã–π –≥–æ–¥ *</label>
                    <input type="text" id="class-year" placeholder="2025-2026">
                </div>
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
                    <select id="homeroom-teacher">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–°—Ç–∞—Ä–æ—Å—Ç–∞</label>
                    <select id="starosta">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∞—Å—Å–∞ -->
    <div id="view-modal" class="modal">
        <div class="modal-content">
            <h2 id="view-title">–ö–ª–∞—Å—Å</h2>
            <div id="view-content">
                <p><strong>–ì–æ–¥:</strong> <span id="view-year"></span></p>
                <p><strong>–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</strong> <span id="view-teacher"></span></p>
                <p><strong>–°—Ç–∞—Ä–æ—Å—Ç–∞:</strong> <span id="view-starosta"></span></p>
                
                <h3>–£—á–µ–Ω–∏–∫–∏ (<span id="students-count">0</span>)</h3>
                <div class="students-list" id="students-list"></div>
            </div>
            <div class="btn-group">
                <button onclick="closeViewModal()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let teachers = [];
        let students = [];

        if (!token) {
            window.location.href = '/';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadTeachers();
            await loadStudents();
            await loadClasses();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
            if (currentUser.role !== 'admin') {
                document.getElementById('create-btn').style.display = 'none';
            }
        });

        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = 
                        `${currentUser.first_name} ${currentUser.last_name}`;
                } else {
                    logout();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                logout();
            }
        }

        async function loadTeachers() {
            try {
                const response = await fetch(`${API_BASE}/users?role=teacher`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    teachers = data.users || [];
                    
                    const select = document.getElementById('homeroom-teacher');
                    teachers.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `${t.first_name} ${t.last_name}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∏—Ç–µ–ª–µ–π:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/users?role=student`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    students = data.users || [];
                    
                    const select = document.getElementById('starosta');
                    students.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = `${s.first_name} ${s.last_name}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤:', error);
            }
        }

        async function loadClasses() {
            try {
                const response = await fetch(`${API_BASE}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('classes-grid');
                    
                    if (data.classes && data.classes.length > 0) {
                        container.innerHTML = data.classes.map(c => `
                            <div class="class-card">
                                <div class="class-header">
                                    <div class="class-name">üè´ ${c.name}</div>
                                    <div class="class-year">${c.year}</div>
                                </div>
                                <div class="class-info">
                                    <p>üë®‚Äçüè´ ${c.homeroom_teacher ? 
                                        c.homeroom_teacher.first_name + ' ' + c.homeroom_teacher.last_name : 
                                        '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</p>
                                    <p>üë§ –°—Ç–∞—Ä–æ—Å—Ç–∞: ${c.starosta ? 
                                        c.starosta.first_name + ' ' + c.starosta.last_name : 
                                        '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</p>
                                </div>
                                <div class="class-actions">
                                    <button onclick="viewClass(${c.id})" class="btn btn-sm">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                    <button onclick="manageStudents(${c.id})" class="btn btn-sm" style="background:#51cf66;">üë• –£—á–µ–Ω–∏–∫–∏</button>
                                    <button onclick="location.href='/static/pages/schedule.html?class_id=${c.id}'" 
                                        class="btn btn-sm">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="empty-state">–ö–ª–∞—Å—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å!</p>';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Å–æ–≤:', error);
            }
        }

        async function viewClass(classId) {
            try {
                const response = await fetch(`${API_BASE}/classes/${classId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const c = data.class;
                    
                    document.getElementById('view-title').textContent = `–ö–ª–∞—Å—Å ${c.name}`;
                    document.getElementById('view-year').textContent = c.year;
                    document.getElementById('view-teacher').textContent = c.homeroom_teacher ? 
                        `${c.homeroom_teacher.first_name} ${c.homeroom_teacher.last_name}` : 
                        '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                    document.getElementById('view-starosta').textContent = c.starosta ? 
                        `${c.starosta.first_name} ${c.starosta.last_name}` : 
                        '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                    
                    const studentsList = document.getElementById('students-list');
                    const students = c.students || [];
                    document.getElementById('students-count').textContent = students.length;
                    
                    if (students.length > 0) {
                        studentsList.innerHTML = students.map(s => `
                            <div class="student-item">
                                <span>üë§ ${s.first_name} ${s.last_name}</span>
                            </div>
                        `).join('');
                    } else {
                        studentsList.innerHTML = '<p class="empty-state">–£—á–µ–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    }
                    
                    document.getElementById('view-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        function closeViewModal() {
            document.getElementById('view-modal').style.display = 'none';
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('class-name').value.trim();
            const year = document.getElementById('class-year').value.trim();
            
            if (!name) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞!');
                return;
            }
            if (!year) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —É—á–µ–±–Ω—ã–π –≥–æ–¥!');
                return;
            }
            
            const data = {
                name: name,
                year: year
            };
            
            const teacherId = document.getElementById('homeroom-teacher').value;
            if (teacherId) data.homeroom_teacher_id = parseInt(teacherId);
            
            const starostaId = document.getElementById('starosta').value;
            if (starostaId) data.starosta_id = parseInt(starostaId);
            
            try {
                const response = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('–ö–ª–∞—Å—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    closeCreateModal();
                    await loadClasses();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏
        let currentClassId = null;

        async function manageStudents(classId) {
            currentClassId = classId;
            
            const classRes = await fetch(`${API_BASE}/classes/${classId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const classData = await classRes.json();
            document.getElementById('manage-class-name').textContent = classData.class.name;

            const studentsRes = await fetch(`${API_BASE}/users?role=student`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const studentsData = await studentsRes.json();
            
            const currentStudentIds = (classData.class.students || []).map(s => s.id);
            const availableStudents = studentsData.users.filter(u => !currentStudentIds.includes(u.id));

            const select = document.getElementById('available-students');
            if (availableStudents.length > 0) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>' + 
                    availableStudents.map(s => 
                        `<option value="${s.id}">${s.last_name} ${s.first_name}</option>`
                    ).join('');
            } else {
                select.innerHTML = '<option value="">–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —É–∂–µ –≤ –∫–ª–∞—Å—Å–µ</option>';
            }

            renderCurrentStudents(classData.class.students || []);
            document.getElementById('manage-students-modal').style.display = 'block';
        }

        function renderCurrentStudents(students) {
            const container = document.getElementById('current-students-list');
            if (students.length === 0) {
                container.innerHTML = '<p style="color:#999;text-align:center;">–í –∫–ª–∞—Å—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>';
                return;
            }

            container.innerHTML = students.map(s => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #e0e0e0;">
                    <span>${s.last_name} ${s.first_name} ${s.middle_name || ''}</span>
                    <button onclick="removeStudentFromClass(${s.id})" class="btn btn-sm" style="background:#ff6b6b;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            `).join('');
        }

        async function addStudentToClass() {
            const studentId = parseInt(document.getElementById('available-students').value);
            if (!studentId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞!');
                return;
            }

            const response = await fetch(`${API_BASE}/classes/${currentClassId}/students`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ student_ids: [studentId] })
            });

            if (response.ok) {
                alert('‚úÖ –£—á–µ–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                manageStudents(currentClassId);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
            }
        }

        async function removeStudentFromClass(studentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ –∏–∑ –∫–ª–∞—Å—Å–∞?')) return;

            const response = await fetch(`${API_BASE}/classes/${currentClassId}/students/${studentId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('‚úÖ –£—á–µ–Ω–∏–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –∫–ª–∞—Å—Å–∞!');
                manageStudents(currentClassId);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        function closeManageStudents() {
            document.getElementById('manage-students-modal').style.display = 'none';
            loadClasses();
        }
    </script>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞–º–∏ -->
    <div id="manage-students-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏ - <span id="manage-class-name"></span></h2>
            
            <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h3>
            <div style="display:flex;gap:10px;margin-bottom:20px;">
                <select id="available-students" style="flex:1;padding:8px;">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
                <button onclick="addStudentToClass()" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <h3>–¢–µ–∫—É—â–∏–µ —É—á–µ–Ω–∏–∫–∏</h3>
            <div id="current-students-list" style="max-height:300px;overflow-y:auto;"></div>

            <div style="margin-top:20px;">
                <button onclick="closeManageStudents()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</body>
</html>
