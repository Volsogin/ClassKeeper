<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/subjects.html">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html" class="active">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <h1>‚úÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h1>

        <div class="filter-bar">
            <select id="class-filter" onchange="loadStudents()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
            </select>
            <input type="date" id="date-filter" onchange="loadStudents()">
            <button onclick="markAll('present')" class="btn btn-success">–í—Å–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç</button>
        </div>

        <div id="students-list"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('date-filter').valueAsDate = new Date();
            await loadClasses();
        });

        async function loadClasses() {
            const response = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('class-filter');
                data.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }
        }

        async function loadStudents() {
            const classId = document.getElementById('class-filter').value;
            if (!classId) return;

            const response = await fetch(`${API_BASE}/classes/${classId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                renderStudents(data.class.students || []);
            }
        }

        function renderStudents(students) {
            const container = document.getElementById('students-list');
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">–í –∫–ª–∞—Å—Å–µ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>';
                return;
            }

            container.innerHTML = `
                <table style="width:100%;background:white;border-radius:8px;margin-top:20px;">
                    <thead>
                        <tr>
                            <th>–£—á–µ–Ω–∏–∫</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(s => `
                            <tr>
                                <td>${s.last_name} ${s.first_name}</td>
                                <td>
                                    <select id="status-${s.id}" style="padding:8px;border-radius:5px;">
                                        <option value="present">‚úÖ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                                        <option value="absent">‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                                        <option value="late">‚è∞ –û–ø–æ–∑–¥–∞–ª</option>
                                        <option value="excused">üìù –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" id="comment-${s.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="padding:8px;width:200px;border-radius:5px;">
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <button onclick="saveAttendance()" class="btn btn-primary" style="margin-top:20px;width:100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
            `;
        }

        async function markAll(status) {
            const selects = document.querySelectorAll('[id^="status-"]');
            selects.forEach(s => s.value = status);
        }

        async function saveAttendance() {
            const classId = parseInt(document.getElementById('class-filter').value);
            const date = document.getElementById('date-filter').value;
            
            const response = await fetch(`${API_BASE}/classes/${classId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const students = data.class.students || [];

            const records = students.map(s => ({
                student_id: s.id,
                class_id: classId,
                date: date,
                status: document.getElementById(`status-${s.id}`).value,
                comment: document.getElementById(`comment-${s.id}`).value
            }));

            const saveResponse = await fetch(`${API_BASE}/attendance/bulk`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ records })
            });

            if (saveResponse.ok) {
                alert('‚úÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            } else {
                const error = await saveResponse.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
