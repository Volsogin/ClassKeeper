<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–±—ä—è–≤–ª–µ–Ω–∏—è - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/announcements.html" class="active">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
            <button onclick="openCreateModal()" class="btn btn-primary" id="create-btn" style="display:none;">‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
        </div>

        <div class="announcements-list" id="announcements-list">
            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è *</label>
                    <textarea id="content" rows="5" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;" required></textarea>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å *</label>
                    <select id="target-role" required>
                        <option value="all">–í—Å–µ–º</option>
                        <option value="teachers">–£—á–∏—Ç–µ–ª—è–º</option>
                        <option value="students">–£—á–µ–Ω–∏–∫–∞–º</option>
                        <option value="parents">–†–æ–¥–∏—Ç–µ–ª—è–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <select id="target-class">
                        <option value="">–í—Å–µ–º –∫–ª–∞—Å—Å–∞–º</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        let currentUser = null;

        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadClasses();
            await loadAnnouncements();
        });

        async function loadCurrentUser() {
            const response = await fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                currentUser = data.user;
                document.getElementById('user-name').textContent = `${data.user.first_name} ${data.user.last_name}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ —É—á–∏—Ç–µ–ª–µ–π
                if (currentUser.role === 'admin' || currentUser.role === 'teacher') {
                    document.getElementById('create-btn').style.display = 'block';
                }
            } else {
                logout();
            }
        }

        async function loadClasses() {
            const response = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('target-class');
                if (data.classes) {
                    data.classes.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });
                }
            }
        }

        async function loadAnnouncements() {
            const response = await fetch(`${API_BASE}/announcements`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                const container = document.getElementById('announcements-list');
                
                if (data.announcements && data.announcements.length > 0) {
                    container.innerHTML = data.announcements.map(a => `
                        <div class="announcement-card">
                            <h3>${a.title}</h3>
                            <p>${a.content}</p>
                            <div class="announcement-meta">
                                <span>üë§ ${a.author?.first_name} ${a.author?.last_name}</span>
                                <span>üìÖ ${new Date(a.created_at).toLocaleDateString('ru-RU')}</span>
                                <span>üéØ ${getTargetName(a.target_role)}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="empty-state">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
                }
            }
        }

        function getTargetName(role) {
            const names = {
                all: '–í—Å–µ–º',
                teachers: '–£—á–∏—Ç–µ–ª—è–º',
                students: '–£—á–µ–Ω–∏–∫–∞–º',
                parents: '–†–æ–¥–∏—Ç–µ–ª—è–º'
            };
            return names[role] || role;
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                target_role: document.getElementById('target-role').value
            };
            
            const classId = document.getElementById('target-class').value;
            if (classId) {
                data.target_class_id = parseInt(classId);
            }
            
            const response = await fetch(`${API_BASE}/announcements`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
                closeCreateModal();
                await loadAnnouncements();
            } else {
                const error = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å'));
            }
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
