<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <h2>üéì ClassKeeper</h2>
        </div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html" class="active">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <p id="school-name"></p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-info">
                    <h3 id="total-students">-</h3>
                    <p>–£—á–µ–Ω–∏–∫–æ–≤</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë®‚Äçüè´</div>
                <div class="stat-info">
                    <h3 id="total-teachers">-</h3>
                    <p>–£—á–∏—Ç–µ–ª–µ–π</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè´</div>
                <div class="stat-info">
                    <h3 id="total-classes">-</h3>
                    <p>–ö–ª–∞—Å—Å–æ–≤</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-info">
                    <h3 id="total-subjects">-</h3>
                    <p>–ü—Ä–µ–¥–º–µ—Ç–æ–≤</p>
                </div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="quick-actions">
            <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="actions-grid" id="quick-actions">
                <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ -->
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div class="recent-section">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <div id="recent-announcements" class="announcements-list">
                <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>

        <!-- –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π -->
        <div class="recent-section" id="parent-section" style="display: none;">
            <h2>–ú–æ–∏ –¥–µ—Ç–∏</h2>
            <div id="children-list" class="children-grid">
                <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!token) {
            window.location.href = '/';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadStats();
            await loadAnnouncements();
            loadQuickActions();
            
            if (currentUser.role === 'parent') {
                await loadChildren();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = 
                        `${currentUser.first_name} ${currentUser.last_name} (${getRoleName(currentUser.role)})`;
                } else {
                    logout();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                logout();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/analytics/school`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const stats = data.stats;
                    
                    document.getElementById('total-students').textContent = stats.TotalStudents || 0;
                    document.getElementById('total-teachers').textContent = stats.TotalTeachers || 0;
                    document.getElementById('total-classes').textContent = stats.TotalClasses || 0;
                    document.getElementById('total-subjects').textContent = stats.TotalSubjects || 0;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        async function loadAnnouncements() {
            try {
                const response = await fetch(`${API_BASE}/announcements?limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('recent-announcements');
                    
                    if (data.announcements && data.announcements.length > 0) {
                        container.innerHTML = data.announcements.map(a => `
                            <div class="announcement-card">
                                <h3>${a.title}</h3>
                                <p>${a.content}</p>
                                <div class="announcement-meta">
                                    <span>üë§ ${a.author?.first_name} ${a.author?.last_name}</span>
                                    <span>üìÖ ${new Date(a.created_at).toLocaleDateString('ru-RU')}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="empty-state">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–µ–π –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è
        async function loadChildren() {
            const section = document.getElementById('parent-section');
            section.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/parents/children`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('children-list');
                    
                    if (data.children && data.children.length > 0) {
                        container.innerHTML = data.children.map(child => `
                            <div class="child-card">
                                <h3>üë§ ${child.first_name} ${child.last_name}</h3>
                                <button onclick="viewChildGrades(${child.id})" class="btn btn-sm">–û—Ü–µ–Ω–∫–∏</button>
                                <button onclick="viewChildAttendance(${child.id})" class="btn btn-sm">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="empty-state">–î–µ—Ç–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–µ–π:', error);
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
        function loadQuickActions() {
            const container = document.getElementById('quick-actions');
            const actions = {
                admin: [
                    { icon: '‚ûï', text: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', link: '/static/pages/users.html' },
                    { icon: 'üè´', text: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏', link: '/static/pages/classes.html' },
                    { icon: 'üìä', text: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', link: '/static/pages/analytics.html' },
                    { icon: '‚öôÔ∏è', text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', link: '/static/pages/settings.html' }
                ],
                teacher: [
                    { icon: 'üìù', text: '–í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏', link: '/static/pages/grades.html' },
                    { icon: '‚úÖ', text: '–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å', link: '/static/pages/attendance.html' },
                    { icon: 'üìö', text: '–ó–∞–¥–∞—Ç—å –î–ó', link: '/static/pages/homework.html' },
                    { icon: 'üì¢', text: '–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', link: '/static/pages/announcements.html' }
                ],
                student: [
                    { icon: 'üìñ', text: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', link: '/static/pages/schedule.html' },
                    { icon: 'üìä', text: '–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏', link: '/static/pages/grades.html' },
                    { icon: 'üìö', text: '–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è', link: '/static/pages/homework.html' },
                    { icon: 'üì¢', text: '–û–±—ä—è–≤–ª–µ–Ω–∏—è', link: '/static/pages/announcements.html' }
                ],
                parent: [
                    { icon: 'üë•', text: '–ú–æ–∏ –¥–µ—Ç–∏', action: 'scrollToChildren' },
                    { icon: 'üìä', text: '–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å', link: '/static/pages/grades.html' },
                    { icon: 'üì¢', text: '–û–±—ä—è–≤–ª–µ–Ω–∏—è', link: '/static/pages/announcements.html' }
                ]
            };

            const userActions = actions[currentUser.role] || actions.student;
            
            container.innerHTML = userActions.map(action => `
                <div class="action-card" onclick="${action.link ? `location.href='${action.link}'` : action.action + '()'}">
                    <div class="action-icon">${action.icon}</div>
                    <p>${action.text}</p>
                </div>
            `).join('');
        }

        function viewChildGrades(childId) {
            window.location.href = `/static/pages/grades.html?student_id=${childId}`;
        }

        function viewChildAttendance(childId) {
            window.location.href = `/static/pages/attendance.html?student_id=${childId}`;
        }

        function scrollToChildren() {
            document.getElementById('parent-section').scrollIntoView({ behavior: 'smooth' });
        }

        function getRoleName(role) {
            const roles = {
                admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                teacher: '–£—á–∏—Ç–µ–ª—å',
                student: '–£—á–µ–Ω–∏–∫',
                parent: '–†–æ–¥–∏—Ç–µ–ª—å',
                starosta: '–°—Ç–∞—Ä–æ—Å—Ç–∞'
            };
            return roles[role] || role;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
