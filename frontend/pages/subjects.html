<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–µ–¥–º–µ—Ç—ã - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/subjects.html" class="active">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
        </div>

        <div id="subjects-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px;"></div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ *</label>
                    <input type="text" id="subject-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="subject-description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', loadSubjects);

        async function loadSubjects() {
            const response = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                renderSubjects(data.subjects || []);
            }
        }

        function renderSubjects(subjects) {
            const container = document.getElementById('subjects-list');
            if (subjects.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1;">–ü—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
                return;
            }

            container.innerHTML = subjects.map(s => `
                <div style="background:white;border-radius:12px;padding:20px;border:2px solid #e0e0e0;transition:all 0.3s;">
                    <h3 style="margin:0 0 10px 0;color:#667eea;">üìö ${s.name}</h3>
                    <p style="color:#666;font-size:0.9rem;margin:10px 0;">${s.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    <div style="margin-top:15px;display:flex;gap:10px;">
                        <button onclick="deleteSubject(${s.id})" class="btn btn-sm" style="background:#ff6b6b;flex:1;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('subject-name').value.trim();
            if (!name) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞!');
                return;
            }

            const subjectData = {
                name: name,
                description: document.getElementById('subject-description').value.trim()
            };

            const response = await fetch(`${API_BASE}/subjects`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(subjectData)
            });

            if (response.ok) {
                alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —Å–æ–∑–¥–∞–Ω!');
                closeCreateModal();
                loadSubjects();
            } else {
                const error = await response.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å'));
            }
        });

        async function deleteSubject(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?')) return;

            const response = await fetch(`${API_BASE}/subjects/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª—ë–Ω!');
                loadSubjects();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
