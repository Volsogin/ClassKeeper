<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ü–µ–Ω–∫–∏ - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/subjects.html">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html" class="active">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä –û—Ü–µ–Ω–∫–∏</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">‚ûï –í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
        </div>

        <div class="filter-bar">
            <select id="class-filter" onchange="loadGrades()">
                <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
            </select>
            <select id="subject-filter" onchange="loadGrades()">
                <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
            </select>
        </div>

        <div id="grades-list"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–£—á–µ–Ω–∏–∫ *</label>
                    <select id="student-id" required></select>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–µ–¥–º–µ—Ç *</label>
                    <select id="subject-id" required></select>
                </div>
                <div class="form-group">
                    <label>–û—Ü–µ–Ω–∫–∞ *</label>
                    <select id="value" required>
                        <option value="5">5 (–û—Ç–ª–∏—á–Ω–æ)</option>
                        <option value="4">4 (–•–æ—Ä–æ—à–æ)</option>
                        <option value="3">3 (–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ)</option>
                        <option value="2">2 (–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ *</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadFilters();
            await loadGrades();
            document.getElementById('date').valueAsDate = new Date();
        });

        async function loadFilters() {
            // –ö–ª–∞—Å—Å—ã
            const classesRes = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (classesRes.ok) {
                const data = await classesRes.json();
                const select = document.getElementById('class-filter');
                data.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }

            // –ü—Ä–µ–¥–º–µ—Ç—ã
            const subjectsRes = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (subjectsRes.ok) {
                const data = await subjectsRes.json();
                const select = document.getElementById('subject-filter');
                data.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });
            }
        }

        async function loadGrades() {
            const classId = document.getElementById('class-filter').value;
            const subjectId = document.getElementById('subject-filter').value;
            
            let url = `${API_BASE}/grades?`;
            if (classId) url += `class_id=${classId}&`;
            if (subjectId) url += `subject_id=${subjectId}&`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                renderGrades(data.grades || []);
            }
        }

        function renderGrades(grades) {
            const container = document.getElementById('grades-list');
            if (grades.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;margin-top:40px;">–û—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }

            container.innerHTML = `
                <table style="width:100%;background:white;border-radius:8px;">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–£—á–µ–Ω–∏–∫</th>
                            <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                            <th>–û—Ü–µ–Ω–∫–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${grades.map(g => `
                            <tr>
                                <td>${new Date(g.date).toLocaleDateString('ru-RU')}</td>
                                <td>${g.student?.last_name} ${g.student?.first_name}</td>
                                <td>${g.subject?.name || '-'}</td>
                                <td><span style="background:${getGradeColor(g.grade)};color:white;padding:5px 10px;border-radius:5px;font-weight:bold;">${g.grade}</span></td>
                                <td>${g.comment || '-'}</td>
                                <td>
                                    <button onclick="deleteGrade(${g.id})" class="btn btn-sm" style="background:#ff6b6b;">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getGradeColor(value) {
            if (value >= 5) return '#51cf66';
            if (value >= 4) return '#4dabf7';
            if (value >= 3) return '#ffd43b';
            return '#ff6b6b';
        }

        async function openCreateModal() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–Ω–∏–∫–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã
            const usersRes = await fetch(`${API_BASE}/users?role=student`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (usersRes.ok) {
                const data = await usersRes.json();
                const select = document.getElementById('student-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>';
                data.users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = `${u.last_name} ${u.first_name}`;
                    select.appendChild(opt);
                });
            }

            const subjectsRes = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (subjectsRes.ok) {
                const data = await subjectsRes.json();
                const select = document.getElementById('subject-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>';
                data.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });
            }

            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const gradeData = {
                student_id: parseInt(document.getElementById('student-id').value),
                subject_id: parseInt(document.getElementById('subject-id').value),
                grade: parseInt(document.getElementById('value').value),
                date: document.getElementById('date').value,
                comment: document.getElementById('comment').value
            };

            const response = await fetch(`${API_BASE}/grades`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gradeData)
            });

            if (response.ok) {
                alert('‚úÖ –û—Ü–µ–Ω–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞!');
                closeCreateModal();
                loadGrades();
            } else {
                const error = await response.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É'));
            }
        });

        async function deleteGrade(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É?')) return;

            const response = await fetch(`${API_BASE}/grades/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('‚úÖ –û—Ü–µ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
                loadGrades();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
