<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ - ClassKeeper</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="/js/navbar.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand"><h2>üéì ClassKeeper</h2></div>
        <div class="navbar-menu">
            <a href="/pages/dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/pages/users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/pages/subjects.html">–ü—Ä–µ–¥–º–µ—Ç—ã</a>
            <a href="/pages/classes.html">–ö–ª–∞—Å—Å—ã</a>
            <a href="/pages/schedule.html" class="active">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            <a href="/pages/grades.html">–û—Ü–µ–Ω–∫–∏</a>
            <a href="/pages/attendance.html">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
            <a href="/pages/homework.html">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a>
            <a href="/pages/announcements.html">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a href="/pages/analytics.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        </div>
        <div class="navbar-user">
            <span id="user-name"></span>
            <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</button>
        </div>

        <div class="filter-bar">
            <select id="class-filter" onchange="loadSchedule()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
            </select>
        </div>

        <div id="schedule-container"></div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
            <form id="create-form">
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å *</label>
                    <select id="class-id" required></select>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–µ–¥–º–µ—Ç *</label>
                    <select id="subject-id" required></select>
                </div>
                <div class="form-group">
                    <label>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ *</label>
                    <select id="day-of-week" required>
                        <option value="–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                        <option value="–í—Ç–æ—Ä–Ω–∏–∫">–í—Ç–æ—Ä–Ω–∏–∫</option>
                        <option value="–°—Ä–µ–¥–∞">–°—Ä–µ–¥–∞</option>
                        <option value="–ß–µ—Ç–≤–µ—Ä–≥">–ß–µ—Ç–≤–µ—Ä–≥</option>
                        <option value="–ü—è—Ç–Ω–∏—Ü–∞">–ü—è—Ç–Ω–∏—Ü–∞</option>
                        <option value="–°—É–±–±–æ—Ç–∞">–°—É–±–±–æ—Ç–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ *</label>
                    <input type="number" id="lesson-number" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ *</label>
                    <input type="time" id="start-time" required>
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                    <input type="time" id="end-time" required>
                </div>
                <div class="form-group">
                    <label>–ö–∞–±–∏–Ω–µ—Ç</label>
                    <input type="text" id="room-number" placeholder="201">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadClasses();
        });

        async function loadClasses() {
            const response = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('class-filter');
                data.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }
        }

        async function loadSchedule() {
            const classId = document.getElementById('class-filter').value;
            if (!classId) return;

            const response = await fetch(`${API_BASE}/schedules/class/${classId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                renderSchedule(data.schedule || {});
            }
        }

        function renderSchedule(schedule) {
            const container = document.getElementById('schedule-container');
            const days = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
            
            if (Object.keys(schedule).length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;margin-top:40px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>';
                return;
            }

            container.innerHTML = days.map(day => {
                const lessons = schedule[day] || [];
                return `
                    <div style="background:white;border-radius:12px;padding:20px;margin:15px 0;">
                        <h3>${day}</h3>
                        ${lessons.length === 0 ? '<p style="color:#999;">–ù–µ—Ç —É—Ä–æ–∫–æ–≤</p>' : `
                            <div style="display:grid;gap:10px;margin-top:10px;">
                                ${lessons.map(l => `
                                    <div style="border-left:4px solid #667eea;padding:10px;background:#f8f9fa;border-radius:8px;">
                                        <strong>${l.lesson_number}. ${l.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç'}</strong><br>
                                        <span style="color:#666;">
                                            ${l.start_time ? l.start_time.substring(11, 16) : ''} - ${l.end_time ? l.end_time.substring(11, 16) : ''}
                                            ${l.room_number ? `| –ö–∞–±. ${l.room_number}` : ''}
                                        </span>
                                        <button onclick="deleteSchedule(${l.id})" class="btn btn-sm" style="background:#ff6b6b;float:right;">üóëÔ∏è</button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function openCreateModal() {
            const classesRes = await fetch(`${API_BASE}/classes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (classesRes.ok) {
                const data = await classesRes.json();
                const select = document.getElementById('class-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
                data.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }

            const subjectsRes = await fetch(`${API_BASE}/subjects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (subjectsRes.ok) {
                const data = await subjectsRes.json();
                const select = document.getElementById('subject-id');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>';
                data.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });
            }

            document.getElementById('create-modal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const scheduleData = {
                class_id: parseInt(document.getElementById('class-id').value),
                subject_id: parseInt(document.getElementById('subject-id').value),
                day_of_week: document.getElementById('day-of-week').value,
                lesson_number: parseInt(document.getElementById('lesson-number').value),
                start_time: document.getElementById('start-time').value,
                end_time: document.getElementById('end-time').value,
                room_number: document.getElementById('room-number').value
            };

            const response = await fetch(`${API_BASE}/schedules`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            });

            if (response.ok) {
                alert('‚úÖ –£—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                closeCreateModal();
                loadSchedule();
            } else {
                const error = await response.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å'));
            }
        });

        async function deleteSchedule(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫?')) return;

            const response = await fetch(`${API_BASE}/schedules/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                alert('‚úÖ –£—Ä–æ–∫ —É–¥–∞–ª—ë–Ω!');
                loadSchedule();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>
